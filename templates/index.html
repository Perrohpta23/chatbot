<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat IA</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <!-- BotÃ³n para mostrar/ocultar la sidebar -->
  <button id="toggle-sidebar" title="Mostrar/ocultar chats">â˜°</button>

  <div id="layout">
    <!-- Sidebar -->
    <aside id="sidebar">
      <div class="sidebar-header">
        <h2>Chats</h2>
        <button id="new-chat">âž• Nuevo chat</button>
      </div>
      <div id="conv-list"></div>
    </aside>

    <!-- Ãrea principal -->
    <main id="main">
      <div id="chat-container">
        <div id="chat-box"></div>

        <!-- Input fijo al fondo y de ancho completo -->
        <div id="input-area">
          <input type="text" id="user-input" placeholder="Escriba algo..." autocomplete="off">
          <button id="send-btn">Enviar</button>
        </div>
      </div>
    </main>
  </div>

  <script>
    // --------- UI helpers ---------
    const chatBox = document.getElementById("chat-box");
    const input = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const newBtn = document.getElementById("new-chat");
    const convListEl = document.getElementById("conv-list");
    const toggleBtn = document.getElementById("toggle-sidebar");

    let currentConversationId = null;

    function addMessage(sender, text) {
      const msg = document.createElement("p");
      msg.classList.add(sender);
      msg.textContent = text;
      chatBox.appendChild(msg);
      // scrollear siempre al final
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Mostrar/ocultar sidebar
    toggleBtn.onclick = () => {
      document.body.classList.toggle("collapsed");
      // despuÃ©s de colapsar, asegurar que el chat siga al fondo
      setTimeout(() => chatBox.scrollTop = chatBox.scrollHeight, 0);
    };

    async function loadConversations() {
      const res = await fetch("/conversations");
      const convs = await res.json();
      convListEl.innerHTML = "";

      convs.forEach(c => {
        const div = document.createElement("div");
        div.className = "conv-item" + (c.id === currentConversationId ? " active" : "");
        div.textContent = c.title || "Chat";
        div.onclick = async () => {
          currentConversationId = c.id;
          await loadHistory();
          await loadConversations();
        };

        const row = document.createElement("div");
        row.className = "conv-actions";
        const renameBtn = document.createElement("button");
        renameBtn.textContent = "âœï¸";
        renameBtn.title = "Renombrar";
        renameBtn.onclick = async (e) => {
          e.stopPropagation();
          const title = prompt("Nuevo tÃ­tulo:", c.title || "Chat");
          if (!title) return;
          await fetch(`/conversations/${c.id}`, {
            method: "PATCH",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ title })
          });
          loadConversations();
        };

        const delBtn = document.createElement("button");
        delBtn.textContent = "ðŸ—‘ï¸";
        delBtn.title = "Borrar";
        delBtn.onclick = async (e) => {
          e.stopPropagation();
          if (!confirm("Â¿Borrar conversaciÃ³n?")) return;
          await fetch(`/conversations/${c.id}`, { method:"DELETE" });
          if (currentConversationId === c.id) {
            currentConversationId = null;
            chatBox.innerHTML = "";
          }
          loadConversations();
        };

        row.appendChild(renameBtn);
        row.appendChild(delBtn);
        div.appendChild(row);
        convListEl.appendChild(div);
      });
    }

    async function loadHistory() {
      if (!currentConversationId) return;
      const res = await fetch(`/history?conversation_id=${currentConversationId}`);
      if (!res.ok) return;
      const history = await res.json();
      chatBox.innerHTML = "";
      history.forEach(m => {
        addMessage(m.role === "user" ? "user" : "bot",
          (m.role === "user" ? "ðŸ§â€â™‚ï¸ " : "ðŸ¤– ") + m.content);
      });
    }

    sendBtn.onclick = async () => {
      const message = input.value.trim();
      if (!message) return;

      // UI
      addMessage("user", "ðŸ§â€â™‚ï¸ " + message);
      input.value = "";
      sendBtn.disabled = true;

      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message, conversation_id: currentConversationId })
        });
        const data = await res.json();
        if (!currentConversationId && data.conversation_id) {
          currentConversationId = data.conversation_id;
          loadConversations();
        }
        addMessage("bot", "ðŸ¤– " + (data.reply || "Error procesando el mensaje"));
      } catch (e) {
        addMessage("bot", "ðŸ¤– Error de red.");
      } finally {
        sendBtn.disabled = false;
        input.focus();
      }
    };

    // Enter para enviar
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendBtn.click();
    });

    // Crear nuevo chat
    newBtn.onclick = async () => {
      const res = await fetch("/conversations", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ title: "Nuevo chat" })
      });
      const data = await res.json();
      currentConversationId = data.id;
      chatBox.innerHTML = "";
      await loadConversations();
    };

    // Cargar al inicio
    loadConversations();
  </script>
</body>
</html>