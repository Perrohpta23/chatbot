<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Void IA</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}">
  <link rel="icon" href="{{ url_for('static', filename='Logo-void.ico') }}">

  <!-- Seguridad y Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script> marked.use({ mangle:false, headerIds:false, smartypants:false }); </script>

  <!-- Highlight.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>

  <!-- MathJax v3 -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['\\(','\\)'], ['$', '$']],
        displayMath: [['\\[','\\]'], ['$$','$$']]
      },
      options: { skipHtmlTags: ['script','noscript','style','textarea','pre','code'] }
    };
    document.addEventListener('DOMContentLoaded', () => hljs.configure({ignoreUnescapedHTML: true}));
  </script>
  <script async id="mathjax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
</head>

<body class="app">
  <!-- Botón para colapsar sidebar -->
  <button id="toggle-sidebar" title="Mostrar/ocultar chats">☰</button>

  <div id="layout">
    <!-- Sidebar -->
    <aside id="sidebar">
      <header class="sidebar-header">
        <button id="new-chat">Nuevo
          <div></div>
          <svg width="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21.2799 6.40005L11.7399 15.94C10.7899 16.89 7.96987 17.33 7.33987 16.7C6.70987 16.07 7.13987 13.25 8.08987 12.3L17.6399 2.75002C17.8754 2.49308 18.1605 2.28654 18.4781 2.14284C18.7956 1.99914 19.139 1.92124 19.4875 1.9139C19.8359 1.90657 20.1823 1.96991 20.5056 2.10012C20.8289 2.23033 21.1225 2.42473 21.3686 2.67153C21.6147 2.91833 21.8083 3.21243 21.9376 3.53609C22.0669 3.85976 22.1294 4.20626 22.1211 4.55471C22.1128 4.90316 22.0339 5.24635 21.8894 5.5635C21.7448 5.88065 21.5375 6.16524 21.2799 6.40005Z" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M11 4H6C4.93913 4 3.92178 4.42142 3.17163 5.17157C2.42149 5.92172 2 6.93913 2 8V18C2 19.0609 2.42149 20.0783 3.17163 20.8284C3.92178 21.5786 4.93913 22 6 22H17C19.21 22 20 20.2 20 18V13" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
        </button>
      </header>
      <nav id="conv-list"></nav>
      <footer class="sidebar-footer"></footer>
    </aside>

    <!-- Área principal -->
    <main id="main">
      <div id="chat-container">
        <div id="chat-box">
          <!-- Placeholder fijo -->
          <div id="chat-empty" class="chat-empty">
            <h2>Bienvenido a</h2>
            <img src="{{ url_for('static', filename='Logo void transparente.png') }}" alt="Void">
            <p>Escribe tu pregunta o usa <b>{ }</b> para insertar código.</p>
          </div>
          <!-- Spacer para que el input no tape el final -->
          <div id="bottom-spacer"></div>
        </div>

        <div id="input-area">
          <input type="text" id="user-input" placeholder="Pregunta lo que quieras" autocomplete="off">
          <button id="code-btn" title="Insertar código">{ }</button>
          <button id="send-btn" title="Enviar">
            <svg width="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="send-alt" class="icon glyph" fill="#ffffff">
              <path d="M21.88,4.73,16.2,20.65A2,2,0,0,1,14.3,22h0a2,2,0,0,1-1.9-1.31l-2.12-5.52,1.54-1.54,2.49-2.49a1,1,0,1,0-1.42-1.42l-2.49,2.49L8.82,13.76,3.31,11.63a2,2,0,0,1,0-3.83L19.27,2.12a2,2,0,0,1,2.61,2.61Z"/>
            </svg>
          </button>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal código -->
  <div id="code-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-card">
      <header class="modal-header">
        <h3>Insertar bloque de código</h3>
        <button class="modal-close" id="code-close">×</button>
      </header>
      <div class="modal-body">
        <label>Lenguaje
          <select id="code-lang">
            <option value="">(auto)</option>
            <option>python</option><option>javascript</option><option>html</option>
            <option>css</option><option>bash</option><option>json</option>
            <option>java</option><option>c</option><option>cpp</option><option>sql</option>
            <option>markdown</option>
          </select>
        </label>
        <label style="margin-top:8px;">Archivo (opcional)
          <input id="code-filename" type="text" placeholder="ej: app.py">
        </label>
        <label style="margin-top:8px;">Código</label>
        <textarea id="code-text" rows="10" spellcheck="false" placeholder="Pegue o escriba su código aquí..."></textarea>
      </div>
      <footer class="modal-footer">
        <button id="code-insert" class="primary">Insertar</button>
      </footer>
    </div>
  </div>

  <script>
    // ====== refs ======
    const chatBox     = document.getElementById("chat-box");
    const spacer      = document.getElementById("bottom-spacer");
    const input       = document.getElementById("user-input");
    const sendBtn     = document.getElementById("send-btn");
    const newBtn      = document.getElementById("new-chat");
    const convListEl  = document.getElementById("conv-list");
    const toggleBtn   = document.getElementById("toggle-sidebar");
    const inputArea   = document.getElementById("input-area");
    const chatEmpty   = document.getElementById("chat-empty");

    const codeBtn     = document.getElementById('code-btn');
    const codeModal   = document.getElementById('code-modal');
    const codeClose   = document.getElementById('code-close');
    const codeInsert  = document.getElementById('code-insert');
    const codeLang    = document.getElementById('code-lang');
    const codeText    = document.getElementById('code-text');
    const codeFilename= document.getElementById('code-filename');

    const COLLAPSE_BP = 1100;
    let currentConversationId = null;

    // ====== helpers placeholder ======
    function updateChatEmpty(){
      const hasMsgs = !!chatBox.querySelector('.row');
      if (chatEmpty) chatEmpty.style.display = hasMsgs ? 'none' : 'grid';
    }
    function clearChat(){
      chatBox.querySelectorAll('.row').forEach(n => n.remove());
      if (spacer && !chatBox.contains(spacer)) chatBox.appendChild(spacer);
      updateChatEmpty();
    }

    // ====== responsive sidebar ======
    function applyResponsiveSidebar(){
      if (window.innerWidth <= COLLAPSE_BP){
        document.body.classList.add('collapsed');
      } else {
        const pref = localStorage.getItem("sidebar_collapsed") === "1";
        document.body.classList.toggle('collapsed', pref);
      }
    }
    window.addEventListener('resize', applyResponsiveSidebar);
    applyResponsiveSidebar();

    toggleBtn.onclick = () => {
      document.body.classList.toggle("collapsed");
      const pref = document.body.classList.contains("collapsed") ? "1" : "0";
      localStorage.setItem("sidebar_collapsed", pref);
      setTimeout(() => chatBox.scrollTop = chatBox.scrollHeight, 0);
    };

    // ====== util ======
    function esc(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    function renderMarkdownWithMath(text){
      const preserved = (text || "")
        .replace(/\\\(/g, '\\\\(').replace(/\\\)/g, '\\\\)')
        .replace(/\\\[/g, '\\\\[').replace(/\\\]/g, '\\\\]');
      return DOMPurify.sanitize(marked.parse(preserved), { USE_PROFILES:{ html:true } });
    }

    function enhanceCodeBlocks(scope=document){
      scope.querySelectorAll("pre > code").forEach(code=>{
        const pre = code.parentElement;
        if (pre.classList.contains("hl-prepared")) return;
        pre.classList.add("hl-prepared");
        try { hljs.highlightElement(code); } catch {}
        const wrap = document.createElement("div"); wrap.className="code-wrap";
        pre.replaceWith(wrap); wrap.appendChild(pre);
        const header = document.createElement("div"); header.className="code-header";
        const meta = document.createElement("span"); meta.className="code-meta";
        const lang = (code.className.match(/language-([a-z0-9+#]+)/i)||[, "texto"])[1];
        meta.textContent = lang.toLowerCase();
        const btn = document.createElement("button"); btn.className="copy-btn"; btn.textContent="Copiar";
        btn.onclick = async ()=>{ await navigator.clipboard.writeText(code.innerText); btn.textContent="Copiado ✓"; setTimeout(()=>btn.textContent="Copiar",1200); };
        header.append(meta, btn); wrap.appendChild(header);
      });
    }

    function addMessage(sender, text, { typeset = true } = {}){
      if (chatEmpty) chatEmpty.style.display = 'none';
      const row = document.createElement("div");
      row.className = "row " + sender;
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = renderMarkdownWithMath(text);
      row.appendChild(bubble);
      chatBox.insertBefore(row, spacer);
      chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: "smooth" });
      enhanceCodeBlocks(bubble);
      if (typeset && window.MathJax?.typesetPromise) MathJax.typesetPromise([bubble]).catch(console.error);
    }

    // ====== composer spacing (móvil) ======
    function autoScroll(force=false){
      const nearBottom = (chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight) < 80;
      if (force || nearBottom) chatBox.scrollTop = chatBox.scrollHeight;
    }
    function syncComposerPadding(){
      const h = Math.ceil(inputArea?.getBoundingClientRect().height || 64);
      document.documentElement.style.setProperty('--composer-h', h+'px');
      if (spacer) spacer.style.height = `calc(${h}px + env(safe-area-inset-bottom) + 12px)`;
      autoScroll(true);
    }
    new ResizeObserver(syncComposerPadding).observe(inputArea);
    window.addEventListener('resize', syncComposerPadding);
    window.addEventListener('orientationchange', syncComposerPadding);
    if (window.visualViewport){
      visualViewport.addEventListener('resize', syncComposerPadding);
      visualViewport.addEventListener('scroll', syncComposerPadding);
    }
    syncComposerPadding();
    updateChatEmpty();

    // ====== Conversaciones (CRUD) ======
    async function loadConversations(){
      const res = await fetch('/conversations');
      const data = await res.json();
      if (!data.length){
        convListEl.innerHTML = `<div class="empty" style="opacity:.7;cursor:default">
          <span>No hay chats aún. Dale a <b>Nuevo</b>.</span>
        </div>`;
        return;
      }
      convListEl.innerHTML = data.map(c => `
        <div class="conv ${c.id===currentConversationId?'active':''}" data-id="${c.id}">
          <span class="conv-title" title="${esc(c.title||'Nuevo chat')}">${esc(c.title||'Nuevo chat')}</span>
          <span class="actions">
            <button class="rename" data-action="rename" title="Renombrar">
              <svg width="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20.1498 7.93997L8.27978 19.81C7.21978 20.88 4.04977 21.3699 3.32977 20.6599C2.60977 19.9499 3.11978 16.78 4.17978 15.71L16.0498 3.84C16.5979 3.31801 17.3283 3.03097 18.0851 3.04019C18.842 3.04942 19.5652 3.35418 20.1004 3.88938C20.6356 4.42457 20.9403 5.14781 20.9496 5.90463C20.9588 6.66146 20.6718 7.39189 20.1498 7.93997Z" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>  
            </button>
            <button class="delete" data-action="delete" title="Borrar">
              <svg width="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20.5001 6H3.5" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round"/><path d="M18.8332 8.5L18.3732 15.3991C18.1962 18.054 18.1077 19.3815 17.2427 20.1907C16.3777 21 15.0473 21 12.3865 21H11.6132C8.95235 21 7.62195 21 6.75694 20.1907C5.89194 19.3815 5.80344 18.054 5.62644 15.3991L5.1665 8.5" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round"/><path d="M9.1709 4C9.58273 2.83481 10.694 2 12.0002 2C13.3064 2 14.4177 2.83481 14.8295 4" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round"/></svg>
            </button>
          </span>
        </div>`).join('');
    }

    convListEl.addEventListener('click', async (e) => {
      const item = e.target.closest('.conv'); if (!item) return;
      const id = item.dataset.id;
      const act = e.target.closest('[data-action]')?.dataset.action;

      if (!act){
        currentConversationId = id;
        document.querySelectorAll('.conv').forEach(x => x.classList.toggle('active', x===item));
        await loadHistory();
        return;
      }
      if (act === 'delete'){
        if (!confirm('¿Borrar esta conversación?')) return;
        await fetch(`/conversations/${id}`, { method:'DELETE' });
        if (currentConversationId === id){
          currentConversationId = null;
          clearChat();          // limpia mensajes y muestra placeholder
        }
        await loadConversations();
        return;
      }
      if (act === 'rename'){
        const actual = item.querySelector('.conv-title').textContent.trim();
        const nuevo = prompt('Nuevo título:', actual);
        if (!nuevo?.trim()) return;
        await fetch(`/conversations/${id}`, {
          method:'PATCH', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ title: nuevo.trim() })
        });
        await loadConversations();
      }
    });

    async function createNewConversation(){
      const res = await fetch("/conversations", {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ title: "Nuevo chat" })
      });
      const data = await res.json();
      currentConversationId = data.id;
      clearChat();                 // placeholder visible hasta primer mensaje
      await loadConversations();
      const el = [...document.querySelectorAll('.conv')].find(x => x.dataset.id === currentConversationId);
      if (el) el.classList.add('active');
    }
    newBtn.onclick = createNewConversation;

    async function loadHistory(){
      if (!currentConversationId) return;
      const res = await fetch(`/history?conversation_id=${currentConversationId}`);
      if (!res.ok) return;
      const history = await res.json();
      clearChat();
      history.forEach(m => addMessage(m.role === "user" ? "user" : "bot", m.content));
      chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: "smooth" });
      syncComposerPadding();
      updateChatEmpty();
    }

    // ====== Envío ======
    sendBtn.onclick = async () => {
      const message = input.value.trim();
      if (!message) return;

      // limpiar ya
      input.value = "";
      sendBtn.disabled = true;

      // UI
      addMessage("user", message);
      const thinkRow = document.createElement("div");
      thinkRow.className = "row bot";
      const thinkBubble = document.createElement("div");
      thinkBubble.className = "bubble thinking";
      thinkBubble.textContent = "Void está pensando...";
      thinkRow.appendChild(thinkBubble);
      chatBox.insertBefore(thinkRow, spacer);
      chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: "smooth" });

      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message, conversation_id: currentConversationId })
        });
        const data = await res.json();

        thinkRow.remove();

        if (!currentConversationId && data.conversation_id) {
          currentConversationId = data.conversation_id;
          await loadConversations();
        }

        addMessage("bot", data.reply || "Error procesando el mensaje");
        syncComposerPadding();

      } catch (e) {
        thinkRow.remove();
        addMessage("bot", "Error de red.");
        console.error(e);
      } finally {
        sendBtn.disabled = false;
        input.focus();
      }
    };

    // Enter para enviar
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendBtn.click(); }
    });

    // Modal código
    function openCodeModal(){ codeText.value=""; codeFilename.value=""; codeLang.value=""; codeModal.classList.remove('hidden'); codeText.focus(); }
    function closeCodeModal(){ codeModal.classList.add('hidden'); }
    codeBtn.onclick = openCodeModal;
    codeClose.onclick = closeCodeModal;
    codeModal.addEventListener('click', (e)=>{ if(e.target === codeModal) closeCodeModal(); });
    codeInsert.onclick = ()=>{
      const lang = (codeLang.value || '').trim();
      const filename = codeFilename.value.trim();
      const code = codeText.value.replace(/\t/g,'  ');
      if(!code) return;
      let header = filename ? `// ${filename}\n` : '';
      if(lang === 'python' || lang === 'bash') header = filename ? `# ${filename}\n` : header;
      const fenced = "```" + (lang || '') + "\n" + header + code + "\n```";
      input.value = fenced;
      closeCodeModal();
      sendBtn.click();
    };

    // Arranque
    loadConversations();
  </script>
</body>
</html>