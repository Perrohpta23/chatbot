<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat IA</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <!-- MathJax v3: TeX -> HTML -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['\\(','\\)'], ['$', '$']],   // soporta \( \) y $ $
        displayMath: [['\\[','\\]'], ['$$','$$']]  // soporta \[ \] y $$ $$
      },
      options: { skipHtmlTags: ['script','noscript','style','textarea','pre','code'] }
    };
  </script>
  <script async id="mathjax-script"
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>

</head>
<body>
  <!-- Botón para mostrar/ocultar la sidebar -->
  <button id="toggle-sidebar" title="Mostrar/ocultar chats">☰</button>

  <div id="layout">
    <!-- Sidebar -->
    <aside id="sidebar">
      <div class="sidebar-header">
        <h2>Chats</h2>
        <button id="new-chat">➕ Nuevo chat</button>
      </div>
      <div id="conv-list"></div>
    </aside>

    <!-- Área principal -->
    <main id="main">
      <div id="chat-container">
        <div id="chat-box"></div>

        <!-- Input fijo al fondo y de ancho completo -->
        <div id="input-area">
          <input type="text" id="user-input" placeholder="Escriba algo..." autocomplete="off">
          <button id="send-btn">Enviar</button>
        </div>
      </div>
    </main>
  </div>
  <!-- Marked (parser Markdown) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    function addMessage(sender, text) {
      const msg = document.createElement("div");
      msg.classList.add(sender);

      // Limpie el HTML de la respuesta antes de inyectar
      const safe = DOMPurify.sanitize(text, {USE_PROFILES: {html: true}});
      msg.innerHTML = safe;

      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;

      if (window.MathJax?.typesetPromise) {
        MathJax.typesetPromise([msg]).catch(console.error);
      }
    }

    // --------- UI helpers ---------
    const chatBox = document.getElementById("chat-box");
    const input = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const newBtn = document.getElementById("new-chat");
    const convListEl = document.getElementById("conv-list");
    const toggleBtn = document.getElementById("toggle-sidebar");

    let currentConversationId = null;

    function addMessage(sender, text) {
      const msg = document.createElement("div");
      msg.classList.add(sender, "msg");

      // si usa DOMPurify (recomendado)
      const safe = DOMPurify.sanitize(text, {USE_PROFILES: {html: true}});
      msg.innerHTML = safe;

      chatBox.appendChild(msg);

      // 🔥 Desplazamiento suave al final
      chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: "smooth" });

      // Renderiza ecuaciones LaTeX
      if (window.MathJax?.typesetPromise) {
        MathJax.typesetPromise([msg]).catch(console.error);
      }

      // si quiere copiar bloques de código
      if (typeof enhanceCodeBlocks === "function") enhanceCodeBlocks(msg);
    }

    function enhanceCodeBlocks(scope = document) {
      scope.querySelectorAll("pre > code").forEach(code => {
        if (code.parentElement.classList.contains("has-copy")) return;
        const pre = code.parentElement;
        pre.classList.add("has-copy");
        const btn = document.createElement("button");
        btn.textContent = "Copiar";
        btn.style.cssText = "position:absolute;top:8px;right:8px;padding:4px 8px;border:1px solid var(--border);background:#2a2a2a;color:#fff;border-radius:6px;cursor:pointer;";
        const wrap = document.createElement("div");
        wrap.style.position = "relative";
        pre.replaceWith(wrap);
        wrap.appendChild(pre);
        wrap.appendChild(btn);
        btn.onclick = async () => {
          await navigator.clipboard.writeText(code.innerText);
          btn.textContent = "Copiado ✓";
          setTimeout(()=>btn.textContent="Copiar",1200);
        };
      });
    }


    // Mostrar/ocultar sidebar
    if (localStorage.getItem("sidebar_collapsed") === "1") {
      document.body.classList.add("collapsed");
    }

    toggleBtn.onclick = () => {
      document.body.classList.toggle("collapsed");
      const v = document.body.classList.contains("collapsed") ? "1" : "0";
      localStorage.setItem("sidebar_collapsed", v);
      setTimeout(() => chatBox.scrollTop = chatBox.scrollHeight, 0);
    };

    async function loadConversations() {
      const res = await fetch("/conversations");
      const convs = await res.json();
      convListEl.innerHTML = "";

      convs.forEach(c => {
        const div = document.createElement("div");
        div.className = "conv-item" + (c.id === currentConversationId ? " active" : "");
        div.textContent = c.title || "Chat";
        div.onclick = async () => {
          currentConversationId = c.id;
          await loadHistory();
          await loadConversations();
        };

        const row = document.createElement("div");
        row.className = "conv-actions";
        const renameBtn = document.createElement("button");
        renameBtn.textContent = "✏️";
        renameBtn.title = "Renombrar";
        renameBtn.onclick = async (e) => {
          e.stopPropagation();
          const title = prompt("Nuevo título:", c.title || "Chat");
          if (!title) return;
          await fetch(`/conversations/${c.id}`, {
            method: "PATCH",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ title })
          });
          loadConversations();
        };

        const delBtn = document.createElement("button");
        delBtn.textContent = "🗑️";
        delBtn.title = "Borrar";
        delBtn.onclick = async (e) => {
          e.stopPropagation();
          if (!confirm("¿Borrar conversación?")) return;
          await fetch(`/conversations/${c.id}`, { method:"DELETE" });
          if (currentConversationId === c.id) {
            currentConversationId = null;
            chatBox.innerHTML = "";
          }
          loadConversations();
        };

        row.appendChild(renameBtn);
        row.appendChild(delBtn);
        div.appendChild(row);
        convListEl.appendChild(div);
      });
    }

    async function loadHistory() {
      if (!currentConversationId) return;
      const res = await fetch(`/history?conversation_id=${currentConversationId}`);
      if (!res.ok) return;
      const history = await res.json();
      chatBox.innerHTML = "";
      history.forEach(m => {
        addMessage(m.role === "user" ? "user" : "bot",
          (m.role === "user" ? "" : " • ") + m.content);
      });
      chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: "smooth" });
    }

    sendBtn.onclick = async () => {
      const message = input.value.trim();
      if (!message) return;

      // UI
      addMessage("user", "" + message);
      input.value = "";
      sendBtn.disabled = true;

      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message, conversation_id: currentConversationId })
        });
        const data = await res.json();
        if (!currentConversationId && data.conversation_id) {
          currentConversationId = data.conversation_id;
          loadConversations();
        }
        addMessage("bot", " • " + (data.reply || "Error procesando el mensaje"));
      } catch (e) {
        addMessage("bot", " • Error de red.");
      } finally {
        sendBtn.disabled = false;
        input.focus();
      }
    };

    // Enter para enviar
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendBtn.click();
    });

    // Crear nuevo chat
    newBtn.onclick = async () => {
      const res = await fetch("/conversations", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ title: "Nuevo chat" })
      });
      const data = await res.json();
      currentConversationId = data.id;
      chatBox.innerHTML = "";
      await loadConversations();
    };

    // Cargar al inicio
    loadConversations();
  </script>
</body>
</html>